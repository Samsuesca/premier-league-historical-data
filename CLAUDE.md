# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an **English Football Pyramid Historical Data Analysis System** that scrapes, validates, and analyzes data from all 5 major divisions of English football (1993-2025).

**Current Version**: v3.0 - Fase 3: English Football Pyramid Expansion

### Project Evolution
- **v1.0 (Archived)**: Wikipedia-based scraping - 36% success rate, archived due to inconsistencies
- **v2.0 (Octubre 2024)**: Premier League only via football-data.co.uk - 100% success rate, 644 records
- **v3.0 (Enero 2025)**: ⭐ Extended to 5 divisions - 2,516 total records, 159 unique teams tracked

### Coverage
- **Premier League** (Nivel 1): 1993-2025, 32 seasons, 644 records
- **Championship** (Nivel 2): 2004-2025, 21 seasons, 504 records
- **League One** (Nivel 3): 2004-2025, 20 seasons, 480 records
- **League Two** (Nivel 4): 2004-2025, 21 seasons, 504 records
- **National League** (Nivel 5): 2005-2025, 16 seasons, 384 records

## Common Commands

### Data Extraction - Premier League Only (Fase 2)
```bash
# Download/update Premier League data (1993-2025)
python scraper_premier_league.py

# Verify Premier League data integrity
python verificar_datos.py
```

### Data Extraction - All Divisions (Fase 3) ⭐ RECOMMENDED
```bash
# Download/update all 5 divisions (Premier to National League)
python scraper_english_leagues.py

# Verify multi-division data integrity
python verificar_english_leagues.py
```

### Analysis
```bash
# Launch Jupyter notebook for Premier League analysis
jupyter notebook analisis_premier_league.ipynb
```

### Dependencies
```bash
# Install required packages
pip install pandas requests numpy matplotlib seaborn jupyter
```

## Architecture & Data Flow

### 1. Data Source Architecture
- **Source**: football-data.co.uk CSV files (URL pattern: `https://www.football-data.co.uk/mmz4281/{YYZZ}/E0.csv`)
- **Rate Limiting**: 0.5s delay between requests in `scraper_premier_league.py:261`
- **Fallback Parsing**: Multiple CSV parsing strategies with different encodings (UTF-8, Latin-1) at `scraper_premier_league.py:64-89`

### 2. Data Processing Pipeline
The scraper follows this workflow:

1. **URL Construction** (`get_football_data_url()` at line 17): Converts season format (e.g., "2015-16") to football-data.co.uk URL codes (e.g., "1516")

2. **Match Data Download** (`download_season()` at line 52): Downloads raw CSV with columns: HomeTeam, AwayTeam, FTHG, FTAG, FTR (H/D/A)

3. **Table Calculation** (lines 124-168): Reconstructs league standings from individual match results:
   - Aggregates home/away results per team
   - Calculates: Wins (FTR='H' for home, 'A' for away), Draws (FTR='D'), Losses
   - Computes: Goals For/Against, Goal Difference, Points (3-1-0 system)

4. **Validation** (lines 290-302): Three-tier consistency check:
   - `G + E + P = PJ` (matches sum validation)
   - `Pts = 3*G + E` (points system validation)
   - Team count: 20-22 per season (Premier League size validation)

5. **Output Generation**:
   - `premier_league_COMPLETO_football_data.csv` - Main dataset with 11 columns
   - `premier_league_tracking_COMPLETO.csv` - Tracking matrix (teams × seasons) generated by `create_tracking()` at line 329

### 3. Data Schema

**Main Dataset** (`premier_league_COMPLETO_football_data.csv`):
```
Temporada | Pos | Equipo | PJ | G | E | P | Pts | GF | GC | Dif
----------|-----|--------|----|----|---|---|-----|----|----|----
1993-94   | 1   | Man United | 42 | 27 | 11 | 4 | 92 | 80 | 38 | +42
```

**Tracking Database** (`premier_league_tracking_COMPLETO.csv`):
- Pivot table structure: Each row = one team
- Columns: `{season}_Pos`, `{season}_Pts` for each of 32 seasons
- Computed metrics: `Total_Temporadas`, `Mejor_Posicion`, `Peor_Posicion`

### 4. Analysis Functions (Jupyter Notebook)

Three reusable query functions defined in `analisis_premier_league.ipynb`:

- **`ver_historial_equipo(nombre)`** (cell 22): Full team history with fuzzy name matching
- **`ver_temporada(temporada)`** (cell 23): Complete season standings table
- **`comparar_equipos(*equipos)`** (cell 24): Comparative analysis across multiple teams

### 5. Error Handling Strategy

**Robust Parsing** (`scraper_premier_league.py:52-200`):
- Multiple parsing attempts with different pandas configurations
- Safe integer conversion with `safe_int_conversion()` at line 37 (handles malformed numeric strings)
- Team name cleaning with `clean_team_name()` at line 30
- Graceful failure logging without stopping entire scrape

**Data Quality Gates**:
- Null value checks before processing (line 96, 111)
- Result validation (must be H/D/A) at line 118
- Empty dataset detection at line 120

## Key Implementation Details

### Season Code Mapping
Years map to football-data.co.uk codes via last 2 digits:
- 1993-94 → "9394"
- 2015-16 → "1516"
- 2024-25 → "2425"

Implementation: `scraper_premier_league.py:17-27`

### Why Wikipedia Was Abandoned (v1.0)
The archived scraper (`archive/scraper_robusto.py`) failed due to:
- Inconsistent HTML table structures across Wikipedia language versions
- Success rate: only 12/33 seasons (36%)
- Unreliable for production use

Migration rationale documented in `archive/README_ARCHIVE.md`

### Validation Results
- **644 records** verified
- **0 errors** in consistency checks
- **100% data quality** across all seasons
- Verification script: `verificar_datos.py`

## Data Characteristics

### Coverage Gaps
- **Missing**: 1992-93 season (not available on football-data.co.uk)
- **Partial**: 2024-25 season (ongoing, updated weekly)

### Historical Constants
- **6 teams** in all 32 seasons: Arsenal, Chelsea, Tottenham, Man United, Everton, Liverpool
- **Variable team count**: 22 teams in 1993-95, then standardized to 20 teams from 1995-96 onward

### Record Holders
- **Most points**: Man City 100 (2017-18) - found in cell 26 of notebook
- **Most goals**: Man City 106 (2017-18) - found in cell 28 of notebook
- **Most titles**: Man United (12), Man City (8)

## Working with This Codebase

### To Update Data for New Season
1. Run `python scraper_premier_league.py` - automatically fetches latest available data
2. Run `python verificar_datos.py` - confirms new data passes validation
3. Check logs for any failed seasons that may need manual investigation

### To Add New Analysis
1. Open `analisis_premier_league.ipynb`
2. Load data: `df = pd.read_csv('premier_league_COMPLETO_football_data.csv')`
3. Use existing functions (`ver_historial_equipo`, `ver_temporada`, `comparar_equipos`) as templates
4. Follow pandas operations pattern from cells 15-28

### To Debug Failed Season Downloads
Use `debug_season(season)` function at `scraper_premier_league.py:203`:
```python
debug_season('2015-16')  # Shows URL, HTTP status, CSV structure, column types
```

### To Extend to Other Leagues
football-data.co.uk supports multiple leagues with different codes:
- E0 = Premier League (England)
- SP1 = La Liga (Spain)
- I1 = Serie A (Italy)
- D1 = Bundesliga (Germany)
- F1 = Ligue 1 (France)

Modify URL pattern in `get_football_data_url()` to change league code.

## Fase 3: English Football Pyramid Expansion Architecture

### Modular Design Pattern

The Fase 3 expansion (`scraper_english_leagues.py`) implements an object-oriented architecture with:

**Base Class**: `EnglishLeagueScraper` (abstract base class at line 19)
- Contains all shared scraping logic
- Abstract methods for division-specific configuration
- Handles URL construction, data parsing, validation, and CSV generation

**Division Subclasses**:
- `PremierLeagueScraper` (line 268): E0 code, 20-22 teams, 1993-2025
- `ChampionshipScraper` (line 280): E1 code, 24 teams, 2004-2025
- `LeagueOneScraper` (line 290): E2 code, 24 teams, 2004-2025
- `LeagueTwoScraper` (line 300): E3 code, 24 teams, 2004-2025
- `NationalLeagueScraper` (line 310): EC code, 24 teams, 2005-2025

### Key Design Decisions

**1. Inheritance over Duplication**
- All scraping logic inherited from base class
- Only division-specific parameters defined in subclasses
- DRY principle: ~400 lines vs. ~2000 lines if duplicated

**2. Flexible Team Count Validation**
- Premier League accepts (20, 22) tuple for 1993-95 seasons
- Other divisions expect exactly 24 teams
- Validation at `validate_team_count()` (line 235)

**3. Unified CSV Schema**
- All divisions output same column structure
- Added `Division` column to differentiate leagues
- Format: `Temporada | Division | Pos | Equipo | PJ | G | E | P | Pts | GF | GC | Dif`

**4. Longitudinal Tracking**
- `create_tracking()` function (line 426) generates tracking matrix
- Tracks division changes across seasons for each team
- Computed metrics: Total_Temporadas, Divisiones_Jugadas, Mejor_Division
- Enables promotion/relegation analysis

### Multi-Division Workflow

Main execution flow in `scrape_all_divisions()` (line 320):

1. **Initialize scrapers** (line 328-334): One instance per division with specific year ranges
2. **Sequential scraping** (line 339): Process each division with delay between requests
3. **Validation per division** (line 351-356): Verify G+E+P=PJ and Pts=3*G+E for each
4. **Combine datasets** (line 376): Concatenate all divisions into single DataFrame
5. **Generate tracking** (line 392): Create longitudinal database with division transitions

### Data Validation Strategy

**Three-tier validation** implemented in `verificar_english_leagues.py`:

1. **Mathematical consistency** (lines 35-47):
   - G + E + P = PJ (matches played)
   - Pts = 3×G + E (points system)

2. **Division-specific team counts** (lines 51-76):
   - Premier: 20-22 teams (variable in early years)
   - Championship/League One/League Two/National: 24 teams
   - Flags anomalies like COVID-19 affected seasons

3. **Cross-division integrity** (lines 115-142):
   - Tracks teams moving between divisions
   - Identifies mobility patterns (ascensos/descensos)
   - Validates no duplicate team-season pairs

### Extending to Additional Divisions

To add National League North/South (Level 6):

1. Create new scraper class:
```python
class NationalLeagueNorthScraper(EnglishLeagueScraper):
    def __init__(self, start_year=2015, end_year=2025):
        super().__init__(
            division_name="National League North",
            division_code="EN",  # Verify code on football-data.co.uk
            expected_teams=22,
            start_year=start_year,
            end_year=end_year
        )
```

2. Add to `scrape_all_divisions()` scrapers list (line 328)
3. Update `verificar_english_leagues.py` expected teams dict (line 51)

### Performance Considerations

- **Rate limiting**: 0.5s delay between requests (line 261)
- **Parallel processing**: Currently sequential; could parallelize division scraping
- **Memory efficiency**: Processes ~110 seasons (~2,500 records) without issues
- **Execution time**: ~3-5 minutes for full 5-division scrape

### Common Issues & Solutions

**Issue**: National League seasons with 22-23 teams instead of 24
**Cause**: COVID-19 seasons (2020-21, 2021-22) had shortened/modified formats
**Solution**: Current code logs warning but accepts; update `expected_teams` to tuple if recurring

**Issue**: pandas SettingWithCopyWarning in tracking generation
**Cause**: DataFrame slicing in `create_tracking()` line 461-462
**Solution**: Use `.copy()` when creating `team_data` slice (non-critical warning)

**Issue**: Team name inconsistencies across divisions
**Cause**: Different naming conventions (e.g., "Man United" vs. "Manchester Utd")
**Solution**: `clean_team_name()` standardizes, but manual mapping may be needed for edge cases
